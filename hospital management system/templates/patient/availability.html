{% extends "base.html" %}

{% block title %}Doctor Availability - HMS{% endblock %}

{% block content %}
<div class="card shadow">
    <div class="card-header">
        <h4 class="mb-0"><i class="bi bi-calendar-event"></i> Dr. {{ doctor.fullname }} - Availability</h4>
        <small class="text-muted">Available time slots for the next 7 days</small>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('patient.check_availability', doctor_id=doctor.id) }}">
            <div class="mb-3">
                <label for="appointment_date" class="form-label">Select Date</label>
                <select class="form-select" id="appointment_date" name="appointment_date" required>
                    <option value="">Choose a date...</option>
                    {% for date in dates %}
                        {% set date_str = date.strftime('%Y-%m-%d') %}
                        {% set avail = availability.get(date_str) %}
                        {% if avail %}
                            <option value="{{ date_str }}">{{ date.strftime('%d/%m/%Y') }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label for="appointment_time" class="form-label">Select Time</label>
                <select class="form-select" id="appointment_time" name="appointment_time" required>
                    <option value="">Choose a time after selecting date...</option>
                </select>
            </div>
            
            <div class="table-responsive mb-3">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Morning Slot</th>
                            <th>Evening Slot</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for date in dates %}
                        {% set date_str = date.strftime('%Y-%m-%d') %}
                        {% set avail = availability.get(date_str) %}
                        <tr>
                            <td><strong>{{ date.strftime('%d/%m/%Y') }}</strong></td>
                            <td>
                                {% if avail and avail.morning_start and avail.morning_end %}
                                    {{ avail.morning_start }} - {{ avail.morning_end }}
                                {% else %}
                                    <span class="text-muted">Not available</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if avail and avail.evening_start and avail.evening_end %}
                                    {{ avail.evening_start }} - {{ avail.evening_end }}
                                {% else %}
                                    <span class="text-muted">Not available</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Book Appointment</button>
            </div>
        </form>
        <div class="mt-3">
            <a href="{{ url_for('patient.view_doctor', doctor_id=doctor.id) }}" class="btn btn-secondary">Go Back</a>
        </div>
    </div>
</div>

<script>
document.getElementById('appointment_date').addEventListener('change', function() {
    const dateSelect = this;
    const timeSelect = document.getElementById('appointment_time');
    const selectedDate = dateSelect.value;
    
    // Clear previous options
    timeSelect.innerHTML = '<option value="">Choose a time...</option>';
    
    if (!selectedDate) return;
    
    // Find availability for selected date
    const availData = {{ availability | tojson }};
    
    // Convert date keys to strings for matching
    const dateStr = selectedDate;
    let avail = null;
    for (const key in availData) {
        if (key === dateStr) {
            avail = availData[key];
            break;
        }
    }
    
    if (!avail) return;
    
    // Generate time slots based on availability
    const times = [];
    
    // Morning slot
    if (avail.morning_start && avail.morning_end) {
        const morningStart = new Date('1970-01-01T' + avail.morning_start + ':00');
        const morningEnd = new Date('1970-01-01T' + avail.morning_end + ':00');
        let current = new Date(morningStart);
        
        while (current <= morningEnd) {
            const timeStr = current.toTimeString().substring(0, 5);
            const booked = {{ booked_slots | tojson }};
            const isBooked = booked.some(slot => slot[0] === selectedDate && slot[1] === timeStr);
            
            if (!isBooked) {
                times.push(timeStr);
            }
            current.setMinutes(current.getMinutes() + 30);
        }
    }
    
    // Evening slot
    if (avail.evening_start && avail.evening_end) {
        const eveningStart = new Date('1970-01-01T' + avail.evening_start + ':00');
        const eveningEnd = new Date('1970-01-01T' + avail.evening_end + ':00');
        let current = new Date(eveningStart);
        
        while (current <= eveningEnd) {
            const timeStr = current.toTimeString().substring(0, 5);
            const booked = {{ booked_slots | tojson }};
            const isBooked = booked.some(slot => slot[0] === selectedDate && slot[1] === timeStr);
            
            if (!isBooked) {
                times.push(timeStr);
            }
            current.setMinutes(current.getMinutes() + 30);
        }
    }
    
    // Populate time options
    times.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        timeSelect.appendChild(option);
    });
});
</script>
{% endblock %}

